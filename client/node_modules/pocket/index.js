/*
  app specific functions to facilitate pocket oauth dance
  @todo try requesting accessToken before doing window.open
  @todo consider replacing popup with full window redirects
*/

var request = require('browser-request')

function pocket(opts){
  this.opts = opts
}

pocket.prototype.auth = {}
pocket.prototype.auth.requestToken = function(){
  var self = this
  request({method:'POST', url:'/auth/pocket/requestToken'}, function(err, resp, body){
    var data = JSON.parse(body)
    if(body.status == 0) console.log(err)
    else {
      self.requestToken = data.requestToken
      var url = 'https://getpocket.com/auth/authorize?request_token='+data.requestToken+'&redirect_uri=http://localhost:3000/auth/pocket/return'
      window.open(url,"pocketOauth","menubar=1,resizable=1,width=700,height=500")
    }
  })
}

pocket.prototype.auth.accessToken = function(){
  var self = this
  $('body').prepend('<div id="thinking">thinking...</div>')
  request({method:'POST', url:'/auth/pocket/accessToken', json:{requestToken: self.requestToken}}, function(err, resp, body){
    $('#thinking').remove()
  })
}


module.exports = function(opts){ return new pocket(opts)}